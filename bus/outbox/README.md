# –ü–∞–∫–µ—Ç `outbox`: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ Transactional Outbox

–ü–∞–∫–µ—Ç `outbox` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "Transactional Outbox" –¥–ª—è Go. –≠—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –±–∏–∑–Ω–µ—Å-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –±—É–¥—É—Ç –Ω–∞–¥–µ–∂–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã, –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ —Å–±–æ–µ–≤. –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ç–æ–π –∂–µ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –∏ –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏) –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∞ –∑–∞—Ç–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –≤ —à–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏–π.

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ì–∞—Ä–∞–Ω—Ç–∏—è "At-Least-Once Delivery":** –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É —Å–æ–±—ã—Ç–∏–π –±–ª–∞–≥–æ–¥–∞—Ä—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—é –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏.
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ –æ–¥–Ω–æ–π –∞—Ç–æ–º–∞—Ä–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö.
- **–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –æ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:** –ü–∞–∫–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Storage`, –ø–æ–∑–≤–æ–ª—è—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—É—é —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—É—é –∏–ª–∏ NoSQL –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
- **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `Retransmitter` –∏ `OutboxMiddleware` –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏", —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∑–∞–¥–∞–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞, –ª–∏–º–∏—Ç—ã –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
- **–ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** `OutboxMiddleware` –ª–µ–≥–∫–æ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é `event.IBus`, –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏–π –∏ –Ω–∞–ø—Ä–∞–≤–ª—è—è –∏—Ö –≤ `Storage`.

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

- **`Message`**: –°—Ç—Ä—É–∫—Ç—É—Ä–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∞—è —Å–æ–±—ã—Ç–∏–µ, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏: —Ç–æ–ø–∏–∫, —Ç–µ–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç–∞—Ç—É—Å.
- **`Storage[T]`**: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–æ–æ–±—â–µ–Ω–∏–π. –ï–≥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤—ã–±–æ—Ä–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π.
- **`OutboxMiddleware[T]`**: Middleware –¥–ª—è —à–∏–Ω—ã —Å–æ–±—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä–æ–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–∑–æ–≤—ã `Publish` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ `Storage` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —à–∏–Ω—É.
- **`Retransmitter[T]`**: –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (worker), –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç `Storage` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ —Ä–µ–∞–ª—å–Ω—É—é —à–∏–Ω—É —Å–æ–±—ã—Ç–∏–π –∏ –ø–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ.
- **–û–ø—Ü–∏–∏ (`With...`)**: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–∏–±–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `OutboxMiddleware` –∏ `Retransmitter`.

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

–î–∏–∞–≥—Ä–∞–º–º–∞ –Ω–∏–∂–µ –∏–ª–ª—é—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –¥–æ –µ–≥–æ –Ω–∞–¥–µ–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏.

```mermaid
sequenceDiagram
    participant App as –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
    participant OutboxMiddleware as Outbox Middleware
    participant Storage as –•—Ä–∞–Ω–∏–ª–∏—â–µ Outbox
    participant Retransmitter as –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä
    participant EventBus as –®–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π

    App->>OutboxMiddleware: Publish(event)
    note right of App: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö –±–∏–∑–Ω–µ—Å-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    OutboxMiddleware->>Storage: Save(message)
    note right of OutboxMiddleware: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ —Ç—É –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

    loop –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å
        Retransmitter->>Storage: Fetch(limit)
        Storage-->>Retransmitter: [messages]
        alt –°–æ–æ–±—â–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã
            Retransmitter->>EventBus: Publish(event)
            EventBus-->>Retransmitter: –£—Å–ø–µ—Ö
            Retransmitter->>Storage: MarkProcessed(message_id)
        end
    end
```

## üìñ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

–°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `outbox.Storage`. –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω –ø—Ä–∏–º–µ—Ä –¥–ª—è PostgreSQL (—Å–º. `examples/outbox/postgres/postgres.go`).

```go
// –≠—Ç–æ—Ç –∫–æ–¥ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–æ–º –∏ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
// querier –∏ —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

type PostgresStorage[T event.Event] struct {
	db *sql.DB
}

func (s *PostgresStorage[T]) Save(ctx context.Context, msg *outbox.Message) error {
	// 1. –ò–∑–≤–ª–µ—á—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
	tx, ok := ctx.Value("tx").(*sql.Tx)
	if !ok {
		return errors.New("—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ")
	}

	// 2. –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å—Ç–∞–≤–∫—É –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
	q := querier.New(tx) // querier –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑ SQL
	return q.CreateOutboxMessage(ctx, querier.CreateOutboxMessageParams{
		ID:        msg.ID,
		Topic:     msg.Topic,
		Payload:   msg.Payload,
		// ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
	})
}

// ... —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Fetch –∏ MarkProcessed ...
```

### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```go
package main

import (
	"context"
	"database/sql"
	"log"
	"time"

	"github.com/x-research-team/dtx-framework/bus/event"
	"github.com/x-research-team/dtx-framework/bus/outbox"
	// ... –∏–º–ø–æ—Ä—Ç –≤–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ storage
)

// –û–ø—Ä–µ–¥–µ–ª–∏–º –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–±—ã—Ç–∏–µ
type UserCreatedEvent struct {
	ID    string
	Email string
	meta  map[string]string
}

func (e *UserCreatedEvent) Metadata() map[string]string { return e.meta }
func (e *UserCreatedEvent) Key() string                  { return e.ID }


func main() {
	// 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ë–î, —Ä–µ–∞–ª—å–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π)
	db, _ := sql.Open("postgres", "...")
	actualBus := event.NewBus[UserCreatedEvent](event.NewLocalProvider[UserCreatedEvent]())
	storage := NewPostgresStorage[UserCreatedEvent](db) // –í–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

	// 2. –°–æ–∑–¥–∞–Ω–∏–µ Outbox Middleware
	outboxMiddleware := outbox.NewOutboxMiddleware[UserCreatedEvent](
		storage,
		outbox.WithTopic[UserCreatedEvent]("user_events"),
	)

	// 3. –û–±–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π —à–∏–Ω—ã –≤ middleware
	// –¢–µ–ø–µ—Ä—å –≤—Å–µ –≤—ã–∑–æ–≤—ã `Publish` –±—É–¥—É—Ç –∏–¥—Ç–∏ –≤ outbox.
	outboxBus := event.NewBus[UserCreatedEvent](outboxMiddleware.Wrap(actualBus.Provider()))

	// 4. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä–∞
	retransmitter := outbox.NewRetransmitter[UserCreatedEvent](
		storage,
		actualBus, // –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é —à–∏–Ω—É
		outbox.WithInterval[UserCreatedEvent](10*time.Second),
		outbox.WithLimit[UserCreatedEvent](50),
	)
	retransmitter.Start()
	defer retransmitter.Stop()

	// 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ
	// –≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏,
	// –≥–¥–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–æ–º–µ—â–µ–Ω –æ–±—ä–µ–∫—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
	ctx := context.Background() // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
	
	err := outboxBus.Publish(ctx, &UserCreatedEvent{
		ID:    "user-456",
		Email: "new.user@example.com",
		meta:  make(map[string]string),
	})
	if err != nil {
		log.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ outbox: %v", err)
	}

	log.Println("–°–æ–±—ã—Ç–∏–µ UserCreatedEvent —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Outbox")
	// –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä –¥–æ—Å—Ç–∞–≤–∏—Ç –µ–≥–æ –ø–æ–∑–∂–µ.
}