# –®–∏–Ω–∞ –ó–∞–ø—Ä–æ—Å–æ–≤ (`bus/query`)

–≠—Ç–æ—Ç –ø–∞–∫–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —à–∏–Ω—É –∑–∞–ø—Ä–æ—Å–æ–≤, —Ä–µ–∞–ª–∏–∑—É—é—â—É—é –ø–∞—Ç—Ç–µ—Ä–Ω "–ü–æ—Å—Ä–µ–¥–Ω–∏–∫" (Mediator) –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º —Å –Ω–∏–∑–∫–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç—å—é –∏ –≤—ã—Å–æ–∫–æ–π —Å—Ç–µ–ø–µ–Ω—å—é –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

## üöÄ –§–∏–ª–æ—Å–æ—Ñ–∏—è

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —à–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–∞–∫ –∏ —à–∏–Ω—ã –∫–æ–º–∞–Ω–¥, –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ **—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —á–µ—Ä–µ–∑ –æ–±–æ–±—â–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã (Generics)**. –≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–∞–±—Å–æ–ª—é—Ç–Ω—É—é —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–∞—è –æ—à–∏–±–∫–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç–∏–ø–æ–≤ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–æ–º, –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –∏ –æ–∂–∏–¥–∞–µ–º—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.

- **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** 100% –æ—à–∏–±–æ–∫, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –Ω–µ–≤–µ—Ä–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–∏–ø–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º.
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ –ø—É–±–ª–∏—á–Ω–æ–º API –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏.
- **–ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è:** –ö–æ–¥, –∏–Ω–∏—Ü–∏–∏—Ä—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å, –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç –æ –µ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ. –û–Ω –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞.

## üéØ –ö–ª—é—á–µ–≤—ã–µ –û—Ç–ª–∏—á–∏—è –æ—Ç –®–∏–Ω—ã –ö–æ–º–∞–Ω–¥

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –®–∏–Ω–∞ –ó–∞–ø—Ä–æ—Å–æ–≤ (`Query Bus`) | –®–∏–Ω–∞ –ö–æ–º–∞–Ω–¥ (`Command Bus`) |
| :--- | :--- | :--- |
| **–ù–∞–º–µ—Ä–µ–Ω–∏–µ** | –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Query). –ù–µ –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã. | –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (Command). –ú–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ. |
| **–ê–¥—Ä–µ—Å–∞—Ç** | –û–¥–∏–Ω –∫ –æ–¥–Ω–æ–º—É. –£ –∑–∞–ø—Ä–æ—Å–∞ **—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω** –æ–±—Ä–∞–±–æ—Ç—á–∏–∫. | –û–¥–∏–Ω –∫ –æ–¥–Ω–æ–º—É. –£ –∫–æ–º–∞–Ω–¥—ã **—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω** –æ–±—Ä–∞–±–æ—Ç—á–∏–∫. |
| **–°–≤—è–∑—å** | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è, –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è. –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å **–≤—Å–µ–≥–¥–∞** –æ–∂–∏–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç. | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è, –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è. –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å **–≤—Å–µ–≥–¥–∞** –æ–∂–∏–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç. |
| **–†–µ–∑—É–ª—å—Ç–∞—Ç** | –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (`R`) –∏–ª–∏ –æ—à–∏–±–∫—É (`error`). | –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (`R`) –∏–ª–∏ –æ—à–∏–±–∫—É (`error`). |

## üìà –î–∏–∞–≥—Ä–∞–º–º–∞ –ü–æ—Ç–æ–∫–∞ –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```mermaid
graph TD
    A[–ö–ª–∏–µ–Ω—Ç] -->|1. –ó–∞–ø—Ä–æ—Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –¥–ª—è GetUserQuery| B(–†–µ–µ—Å—Ç—Ä);
    B -->|2. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç IDispatcher| A;
    A -->|3. –í—ã–∑–æ–≤ Dispatch —Å GetUserQuery| C{–î–∏—Å–ø–µ—Ç—á–µ—Ä GetUserQuery};
    C -->|4. –í—ã–∑–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞| D[–û–±—Ä–∞–±–æ—Ç—á–∏–∫ GetUserQuery];
    D -->|5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç UserDTO| C;
    C -->|6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç UserDTO| A;
```

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ó–∞–ø—Ä–æ—Å–∞ –∏ –µ–≥–æ –†–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ó–∞–ø—Ä–æ—Å ‚Äî —ç—Ç–æ –ª—é–±–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö. –û–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ—Ç—Å—è —Ç–∏–ø–æ–º —Å–≤–æ–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å-–º–∞—Ä–∫–µ—Ä `Query[R]`.

```go
import "time"

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (DTO).
type UserDTO struct {
	ID        string
	Email     string
	CreatedAt time.Time
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–ø—Ä–æ—Å. –û–Ω –Ω–µ –Ω–µ—Å–µ—Ç –ª–æ–≥–∏–∫–∏, —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞.
// –í–ê–ñ–ù–û: –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω —Å–≤–æ–∏–º —Ç–∏–ø–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
type GetUserQuery struct {
	UserID string
}

// –ß—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å –∑–∞–ø—Ä–æ—Å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Query[R].
var _ Query[UserDTO] = (*GetUserQuery)(nil)
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –î–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –∏–∑ –†–µ–µ—Å—Ç—Ä–∞

–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —à–∏–Ω–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `Registry`, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–≤.

```go
import "github.com/your-repo/dtx-framework/bus/query"

// 1. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–µ—Å—Ç—Ä. –û–±—ã—á–Ω–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
registry := query.NewRegistry()

// 2. –ü–æ–ª—É—á–∏—Ç–µ —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
// "users.get_by_id" - —ç—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è —ç—Ç–æ–π –ø–∞—Ä—ã –∑–∞–ø—Ä–æ—Å-—Ä–µ–∑—É–ª—å—Ç–∞—Ç.
userDispatcher, err := query.Dispatcher[GetUserQuery, UserDTO](registry, "users.get_by_id")
if err != nil {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
}
```

### 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (DTO) –∏–ª–∏ –æ—à–∏–±–∫—É.

```go
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è GetUserQuery
func handleGetUser(ctx context.Context, qry GetUserQuery) (UserDTO, error) {
	fmt.Printf("–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID: %s\n", qry.UserID)
	
	// ... –∑–¥–µ—Å—å –≤–∞—à–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î ...
	
	if qry.UserID == "" {
		return UserDTO{}, errors.New("UserID –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
	}

	return UserDTO{
		ID:        qry.UserID,
		Email:     "user@example.com",
		CreatedAt: time.Now(),
	}, nil
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ.
err = userDispatcher.Register(handleGetUser)
if err != nil {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
}
```

### 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –ó–∞–ø—Ä–æ—Å–∞ –∏ –ü–æ–ª—É—á–µ–Ω–∏–µ –†–µ–∑—É–ª—å—Ç–∞—Ç–∞

–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ‚Äî —ç—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

```go
// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∑–∞–ø—Ä–æ—Å–∞
qry := GetUserQuery{
	UserID: "user-123",
}

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∏ –∂–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
result, err := userDispatcher.Dispatch(context.Background(), qry)
if err != nil {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
}

fmt.Printf("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: Email=%s\n", result.Email)
```

### 5. –ì–∞—Ä–∞–Ω—Ç–∏–∏ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–õ—é–±–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä —Å –Ω–µ–≤–µ—Ä–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º.

```go
// –û–®–ò–ë–ö–ê –ö–û–ú–ü–ò–õ–Ø–¶–ò–ò!
// –î–∏—Å–ø–µ—Ç—á–µ—Ä –æ–∂–∏–¥–∞–µ—Ç GetUserQuery, –∞ –≤—ã –ø–µ—Ä–µ–¥–∞–µ—Ç–µ –¥—Ä—É–≥—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
// _, err := userDispatcher.Dispatch(context.Background(), struct{}{})

// –û–®–ò–ë–ö–ê –ö–û–ú–ü–ò–õ–Ø–¶–ò–ò!
// –î–∏—Å–ø–µ—Ç—á–µ—Ä –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è GetUserQuery, –∞ –Ω–µ –¥–ª—è –¥—Ä—É–≥–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
// err := userDispatcher.Register(func(ctx context.Context, qry struct{}) (UserDTO, error) { ... })