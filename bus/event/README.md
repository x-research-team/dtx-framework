# –®–∏–Ω–∞ –°–æ–±—ã—Ç–∏–π (`bus/event`)

–≠—Ç–æ—Ç –ø–∞–∫–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é, –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—É—é –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é —à–∏–Ω—É —Å–æ–±—ã—Ç–∏–π.

## üöÄ –§–∏–ª–æ—Å–æ—Ñ–∏—è

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ **—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —à–∏–Ω—ã**, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–∞–±—Å–æ–ª—é—Ç–Ω—É—é —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**. –ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç `any` –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ –ø—É–±–ª–∏—á–Ω—ã—Ö API –≤ –ø–æ–ª—å–∑—É –æ–±–æ–±—â–µ–Ω–Ω—ã—Ö (Generics) —Ç–∏–ø–æ–≤.

- **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** 100% –æ—à–∏–±–æ–∫, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º.
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã.
- **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å API:** –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —è—Å–Ω—ã, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã –∏ —Å–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º—ã.

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –°–æ–±—ã—Ç–∏–π

–°–æ–±—ã—Ç–∏–µ ‚Äî —ç—Ç–æ –ª—é–±–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö. –û–Ω–∞ –Ω–µ –æ–±—è–∑–∞–Ω–∞ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –º–µ—Ç–æ–¥—ã.

```go
// –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
type UserCreatedEvent struct {
    UserID   string
    Email    string
    CreatedAt time.Time
}

// –°–æ–±—ã—Ç–∏–µ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞
type OrderPaidEvent struct {
    OrderID string
    Amount  float64
}
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –®–∏–Ω—ã

–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —à–∏–Ω–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `Registry`, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º.

```go
import "github.com/your-repo/dtx-framework/bus/event"

// 1. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–µ—Å—Ç—Ä. –û–±—ã—á–Ω–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
registry := event.NewRegistry()

// 2. –ü–æ–ª—É—á–∏—Ç–µ —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∏–Ω—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –∏ —Ç–æ–ø–∏–∫–∞.
userBus, err := event.Bus[UserCreatedEvent](registry, "users.created")
if err != nil {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
}

// 3. –ü–æ–ª—É—á–∏—Ç–µ –¥—Ä—É–≥—É—é —à–∏–Ω—É –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
orderBus, err := event.Bus[OrderPaidEvent](registry, "orders.paid")
if err != nil {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
}
```

### 3. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –°–æ–±—ã—Ç–∏—è

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∏–≥–Ω–∞—Ç—É—Ä—É `func(ctx context.Context, event T) error`.

```go
// –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
unsubscribe, err := userBus.Subscribe(
    func(ctx context.Context, e UserCreatedEvent) error {
        fmt.Printf("–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: %s\n", e.UserID)
        return nil
    },
)
// ...
// –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
defer unsubscribe()
```

### 4. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –°–æ–±—ã—Ç–∏–π

–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ —à–∏–Ω—É, —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥—Ä—É–≥–∏–º —Å–æ–±—ã—Ç–∏–µ–º, –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –æ—à–∏–±–∫–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏.

```go
// –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è
err = userBus.Publish(context.Background(), UserCreatedEvent{UserID: "user-123"})
// ...

// –û–®–ò–ë–ö–ê –ö–û–ú–ü–ò–õ–Ø–¶–ò–ò!
// err = userBus.Publish(context.Background(), OrderPaidEvent{OrderID: "order-456"})
```

### 5. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –û–ø—Ü–∏–∏ –ü–æ–¥–ø–∏—Å–∫–∏

#### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –û–±—Ä–∞–±–æ—Ç–∫–∞

–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø—Ü–∏—é `WithAsync`.

```go
bus.Subscribe(
    handler,
    event.WithAsync[UserCreatedEvent](),
)
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫

–î–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `WithErrorHandler`.

```go
bus.Subscribe(
    handler,
    event.WithErrorHandler(func(err error, e UserCreatedEvent) {
        log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è %v: %v", e, err)
    }),
)
```

#### –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û (Middleware)

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–≤–æ–∑–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–µ—Ç—Ä–∏–∫–∏, —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `WithMiddleware`.

```go
loggingMiddleware := func(next event.EventHandler[UserCreatedEvent]) event.EventHandler[UserCreatedEvent] {
    return func(ctx context.Context, e UserCreatedEvent) error {
        log.Printf("–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è: %v", e)
        err := next(ctx, e)
        log.Printf("–ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è: %v", e)
        return err
    }
}

bus.Subscribe(
    handler,
    event.WithMiddleware(loggingMiddleware),
)