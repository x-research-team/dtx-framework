# Event Bus

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è, –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è, —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è Go.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*   **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∂–µ–Ω–µ—Ä–∏–∫–æ–≤ (Generics) –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–∏–ø–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä `func(ctx, UserCreatedEvent)`, –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä—É—á–Ω–æ–≥–æ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤.
*   **–†–∞—Å—à–∏—Ä—è–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:** –®–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Provider`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω—è—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `LocalProvider` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è Kafka, NATS –∏–ª–∏ –ª—é–±–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ –±—Ä–æ–∫–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π).
*   **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ.
*   **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö, —Ç–∞–∫ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π —Å –ø–æ–º–æ—â—å—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø—É–ª–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤.
*   **–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û (Middleware):** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è middleware –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
*   **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏–Ω—ã –∏ –ø–æ–¥–ø–∏—Å–æ–∫ —Å –ø–æ–º–æ—â—å—é –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏".
*   **–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å:** –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫.
*   **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π.
*   **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ CQRS:** –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ CQRS –≤ –≤–∞—à–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.

### üìà Mermaid-–¥–∏–∞–≥—Ä–∞–º–º–∞

```mermaid
graph TD
    subgraph –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ö–æ–¥
        Client[–ö–ª–∏–µ–Ω—Ç]
    end
    subgraph –®–∏–Ω–∞ –°–æ–±—ã—Ç–∏–π [bus.event]
        Bus(Bus) -- –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤—ã --> ProviderInterface{Provider}
    end
    subgraph –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã
        ProviderInterface -- —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è --> LocalProvider[LocalProvider]
        ProviderInterface -- —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è --> KafkaProvider[KafkaProvider]
        ProviderInterface -- —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è --> NatsProvider[NatsProvider]
        ProviderInterface -- —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è --> ChanProvider[ChanProvider]
    end
    subgraph –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã LocalProvider
        LocalProvider -- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç --> WorkerPool[WorkerPool]
        LocalProvider -- —É–ø—Ä–∞–≤–ª—è–µ—Ç --> Subscribers[–ö–∞—Ä—Ç–∞ –ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤]
        LocalProvider -- —É–ø—Ä–∞–≤–ª—è–µ—Ç --> Cache[–ö–µ—à –ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤]
    end
    Client -- –≤—ã–∑—ã–≤–∞–µ—Ç --> Bus
    KafkaProvider -- –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç --> KafkaBroker[–í–Ω–µ—à–Ω–∏–π –±—Ä–æ–∫–µ—Ä Kafka]
    NatsProvider -- –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç --> NatsBroker[–í–Ω–µ—à–Ω–∏–π –±—Ä–æ–∫–µ—Ä NATS]
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
go get github.com/X-Research-Team/dtx-framework/bus/event
```

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω –ø–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —à–∏–Ω—ã —Å–æ–±—ã—Ç–∏–π, –≤–∫–ª—é—á–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ —Å–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.

```go
package main

import (
	"context"
	"fmt"
	"log"
	"sync"
	"time"

	"github.com/X-Research-Team/dtx-framework/bus/event"
)

// 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

// UserCreatedEvent - —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
type UserCreatedEvent struct {
	UserID string
	Email  string
}

func (e UserCreatedEvent) Topic() string {
	return "user.created"
}

// OrderPlacedEvent - —Å–æ–±—ã—Ç–∏–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
type OrderPlacedEvent struct {
	OrderID string
	Amount  float64
}

func (e OrderPlacedEvent) Topic() string {
	return "order.placed"
}

// 2. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏–Ω—ã

func main() {
	// –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —à–∏–Ω—É —Å–æ–±—ã—Ç–∏–π —Å –æ–ø—Ü–∏—è–º–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–µ—Ç—Ä–∏–∫.
	// –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –ø–µ—Ä–µ–¥–∞–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –æ–ø—Ü–∏—é WithProvider.
	// bus, _ := event.NewBus(event.WithProvider(your_provider.New()))
	bus, err := event.NewBus(
		// –ü—Ä–∏–º–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞
		event.WithLogger(log.New(log.Writer(), "[EventBus] ", log.LstdFlags)),
		// –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—É–ª–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤
		event.WithWorkerPoolConfig(2, 10, 256),
	)
	if err != nil {
		log.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —à–∏–Ω—É: %v", err)
	}
	defer bus.Shutdown(context.Background())

	// 3. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

	// –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è UserCreatedEvent.
	userCreatedHandler := func(ctx context.Context, ev UserCreatedEvent) error {
		fmt.Printf("[–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: ID=%s, Email=%s\n", ev.UserID, ev.Email)
		return nil
	}

	// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è OrderPlacedEvent.
	orderPlacedHandler := func(ctx context.Context, ev OrderPlacedEvent) error {
		fmt.Printf("[–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫] –ó–∞–∫–∞–∑ —Ä–∞–∑–º–µ—â–µ–Ω: ID=%s, –°—É–º–º–∞=%.2f\n", ev.OrderID, ev.Amount)
		time.Sleep(100 * time.Millisecond) // –ò–º–∏—Ç–∞—Ü–∏—è –¥–æ–ª–≥–æ–π —Ä–∞–±–æ—Ç—ã
		return nil
	}

	// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è.
	orderErrorHandler := func(err error, e OrderPlacedEvent) {
		log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ OrderPlacedEvent %v: %v", e, err)
	}

	// 4. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è

	// –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.
	unsubscribeUser, err := bus.Subscribe(UserCreatedEvent{}.Topic(), userCreatedHandler)
	if err != nil {
		log.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ 'user.created': %v", err)
	}
	defer unsubscribeUser()

	// –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –æ—à–∏–±–æ–∫.
	unsubscribeOrder, err := bus.Subscribe(
		OrderPlacedEvent{}.Topic(),
		orderPlacedHandler,
		event.WithAsync[OrderPlacedEvent](),
		event.WithErrorHandler[OrderPlacedEvent](orderErrorHandler),
	)
	if err != nil {
		log.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ 'order.placed': %v", err)
	}
	defer unsubscribeOrder()

	// 5. –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π

	fmt.Println("–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π...")
	var wg sync.WaitGroup
	wg.Add(2)

	go func() {
		defer wg.Done()
		err := bus.Publish(context.Background(), UserCreatedEvent{UserID: "user-123", Email: "test@example.com"})
		if err != nil {
			log.Printf("–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ UserCreatedEvent: %v", err)
		}
	}()

	go func() {
		defer wg.Done()
		err := bus.Publish(context.Background(), OrderPlacedEvent{OrderID: "order-456", Amount: 99.99})
		if err != nil {
			log.Printf("–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ OrderPlacedEvent: %v", err)
		}
	}()

	wg.Wait()
	fmt.Println("–í—Å–µ —Å–æ–±—ã—Ç–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã.")

	// 6. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
	// defer bus.Shutdown() –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–≤–µ—Ä—à–∞—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É.
	fmt.Println("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")
}
```

## API

### `event.Event`

–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –ª—é–±–æ–µ —Å–æ–±—ã—Ç–∏–µ.

```go
type Event interface {
    Topic() string
}
```

### `event.EventHandler[T]`

–¢–∏–ø –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π. `T` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–∏–ø–æ–º, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–º `event.Event`.

```go
type EventHandler[T Event] func(ctx context.Context, event T) error
```

### `event.EventBus`

–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —à–∏–Ω—ã —Å–æ–±—ã—Ç–∏–π. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `*Bus[T]` —è–≤–ª—è–µ—Ç—Å—è –æ–±–æ–±—â–µ–Ω–Ω–æ–π, –Ω–æ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `NewBus` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `*Bus[Event]`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ª—é–±—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏.

```go
// –ü–æ–ª–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏. –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:
Publish(ctx context.Context, event Event) error
Subscribe(topic string, handler any, opts ...SubscribeOption[Event]) (unsubscribe func(), err error)
Shutdown(ctx context.Context) error
```

### `event.NewBus(...)`

–§—É–Ω–∫—Ü–∏—è-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —à–∏–Ω—ã.

```go
func NewBus(opts ...BusOption) *Bus[Event]
```

### `Subscribe`

–ú–µ—Ç–æ–¥ `Subscribe` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `any` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ—Ñ–ª–µ–∫—Å–∏—é –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∏–¥–∞ `func(ctx, YourEventType) error`, –∏ —à–∏–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –æ–±–µ—Ä—Ç–∫—É.

### –û–ø—Ü–∏–∏

–®–∏–Ω–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏", —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å.

#### –û–ø—Ü–∏–∏ –¥–ª—è `NewBus` (`BusOption`)

–≠—Ç–∏ –æ–ø—Ü–∏–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `NewBus` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è —à–∏–Ω—ã.

*   `WithProvider(p Provider)`: –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `LocalProvider` –Ω–∞ –ª—é–±—É—é –¥—Ä—É–≥—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, Kafka, NATS). –≠—Ç–æ –∫–ª—é—á–µ–≤–∞—è –æ–ø—Ü–∏—è –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.
    ```go
    // –ü—Ä–∏–º–µ—Ä: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
    // import "your/custom/provider"
    // customProvider := provider.New()
    // bus, _ := event.NewBus(event.WithProvider(customProvider))
    ```
*   `WithLogger(logger Logger)`: –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –≤–∞—à –ª–æ–≥–≥–µ—Ä (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º `event.Logger`) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç —à–∏–Ω—ã.
    ```go
    // –ü—Ä–∏–º–µ—Ä: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞
    // import "log"
    // myLogger := log.New(os.Stdout, "[EventBus] ", log.LstdFlags)
    // bus, _ := event.NewBus(event.WithLogger(myLogger))
    ```
*   `WithMetrics(metrics Metrics)`: –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É –º–µ—Ç—Ä–∏–∫ (—Å–æ–≤–º–µ—Å—Ç–∏–º—É—é —Å `event.Metrics`) –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏).
    ```go
    // –ü—Ä–∏–º–µ—Ä: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫
    // import "your/metrics/collector"
    // myMetrics := collector.New()
    // bus, _ := event.NewBus(event.WithMetrics(myMetrics))
    ```
*   `WithWorkerPoolConfig(min, max, queueSize int)`: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø—É–ª–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `LocalProvider` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π.
    *   `min`: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤.
    *   `max`: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤.
    *   `queueSize`: —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –∑–∞–¥–∞—á.

#### –û–ø—Ü–∏–∏ –¥–ª—è `Subscribe` (`SubscribeOption[T]`)

–≠—Ç–∏ –æ–ø—Ü–∏–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –º–µ—Ç–æ–¥ `Subscribe` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.

*   `WithAsync[T]()`: –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–∞–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ (–∏–∑ –ø—É–ª–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤). –ë–µ–∑ —ç—Ç–æ–π –æ–ø—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.
*   `WithErrorHandler[T](handler ErrorHandler[T])`: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞, –µ—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É.
*   `WithMiddleware[T](mw ...Middleware[T])`: –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û (middleware) –∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É. Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, –æ–±–æ—Ä–∞—á–∏–≤–∞—è –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.